{% extends "layout.html" %}

{% block content %}
<div style="padding: 2rem; font-size: 1rem;">
  <h2 style="margin-bottom: 1rem;">
    <i class="fas fa-align-left"></i> Konkordanzansicht
  </h2>

  {% if results %}
  <p>Suchergebnisse: </p>
  <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
    <thead>
      <tr>
        <th style="width: 30%; border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">Left Context</th>
        <th style="width: 15%; border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">Hit</th>
        <th style="width: 30%; border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">Right Context</th>
        <th style="width: 15%; border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">Empfänger</th>
      </tr>
    </thead>
    <tbody>
      {% for result in results %}
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">{{ result.left }}</td>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; color: {{ result.selected_color }}; white-space: nowrap;">
          <div style="display: flex; align-items: center; gap: 6px;">
            <span>{{ result.matched_word }}</span>
            <a href="{{ url_for('chat.chat_view', chat_id=result.message.chat_id) }}#msg-{{ result.message.message_id }}" 
              title="Im vollständigen Chat anzeigen" 
              style="text-decoration: none;">
              <img src="{{ url_for('static', filename='icons/arrow_out_square.svg') }}" 
                  alt="Arrow icon" 
                  style="width: 14px; height: 14px;">
            </a>
          </div>
        </td>
        <td style="border: 1px solid #ddd; padding: 8px;">{{ result.right }}</td>
        <td style="border: 1px solid #ddd; padding: 8px;">
          {{ result.message.get_recipient().name }}
          <a href="{{ url_for('profile.author_profile', author_id=result.message.get_recipient().id) }}?no_active_change=1"
            title="Im vollständigen Chat anzeigen"
            style="margin-left: 5px; text-decoration: none;">
            <img src="{{ url_for('static', filename='icons/arrow_out_square.svg') }}" alt="Arrow icon" style="width: 16px; height: 16px;">
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
      <p style="margin-top: 1rem; color: #888;">Keine Treffer gefunden.</p>
  {% endif %}

  <!-- Search Form -->
  <form method="get" action="{{ url_for('konkordanz.konkordanz_view') }}">
    <div class="search-container" style="max-width: 600px;"> <!--set max width here!-->

      {# Macro for recursive rendering of search nodes #}

      {% macro render_search_node(n, idx) %}
        {# Logic node (AND/OR/NOT) #}
        {% if n.filter_type %}
          <div class="complex-search-group" style="margin-top:1rem; display:flex; flex-direction:column; gap:0.5rem; padding:0.5rem 0.5rem; border-radius:6px; border:1px solid #e0e0e0;">
            <div style="display:flex; gap:0.5rem; align-items:center;">
              <label style="font-weight:bold;">Logik:</label>
              <select name="logic_operator[{{ idx }}]" class="logic-operator-dropdown">
                <option value="AND" {% if n.filter_type.name == 'AND' %}selected{% endif %}>AND</option>
                <option value="OR" {% if n.filter_type.name == 'OR' %}selected{% endif %}>OR</option>
                <option value="NOT" {% if n.filter_type.name == 'NOT' %}selected{% endif %}>NOT</option>
              </select>
              <button type="button" class="delete-complex-search-btn"
                      style="padding:0.3rem 0.6rem; background:#dc3545; color:white; border:none; border-radius:4px;">
                ✕
              </button>
            </div>
            <div class="grouped-searches" style="margin-left:2rem;">
              {% for child in n.children %}
                {{ render_search_node(child, idx ~ '.' ~ loop.index0) }}
              {% endfor %}
            </div>
          </div>
        {% else %}
        {# Leaf node (simple search) #}
          <div class="search-group" style="margin-top:1rem; display:flex; gap:0.5rem; align-items:center;">
            <!-- Left dropdown -->
            <select name="selected_type[{{ idx }}]" class="search-konkordanz-dropdown">
              <option value="" {% if not n.filter_node_group %}selected{% endif %}>— Type —</option>
              {% for ft in filter_node_groups %}
                <option value="{{ ft.value }}"
                        {% if ft == n.filter_node_group %}selected{% endif %}>
                  {{ ft.name.title().replace('_', ' ') }}
                </option>
              {% endfor %}
            </select>

            <!-- Keyword input -->
            <div class="search-konkordanz-bar" style="display:flex; align-items:center; gap:0.5rem;">
              <input  type="text"
                      name="keyword[{{ idx }}]"
                      class="search-konkordanz-input"
                      placeholder="Suchbegriff..."
                      value="{{ n.searchbar_input }}"
                      {% if n.filter_node_group != filter_node_groups.WORD %}disabled{% endif %}>

              <div class="search-konkordanz-options">
                <span class="search-toggle" title="Groß-/Kleinschreibung"
                      data-toggle-id="case_sensitive_{{ idx }}">Aa</span>
                <span class="search-toggle" title="Nur ganze Wörter suchen"
                      data-toggle-id="whole_word_{{ idx }}">ab|</span>
                <span class="search-toggle" title="Regulären Ausdruck verwenden"
                      data-toggle-id="use_regex_{{ idx }}">.*</span>
              </div>

              <!-- Hidden toggles -->
              <input type="checkbox" id="case_sensitive_{{ idx }}"
                    class="hidden-toggle"
                    name="case_sensitive[{{ idx }}]"
                    value="1" {% if n.case_sensitive %}checked{% endif %}>
              <input type="checkbox" id="whole_word_{{ idx }}"
                    class="hidden-toggle"
                    name="whole_word[{{ idx }}]"
                    value="1" {% if n.whole_word %}checked{% endif %}>
              <input type="checkbox" id="use_regex_{{ idx }}"
                    class="hidden-toggle"
                    name="use_regex[{{ idx }}]"
                    value="1" {% if n.use_regex %}checked{% endif %}>
            </div>

            <!-- Right dropdown -->
            <select name="selected_scope[{{ idx }}]"
                    class="search-konkordanz-dropdown"
                    {% if n.scope_choices is defined and n.scope_choices|length == 0 %}disabled{% endif %}>
              <option value="" {% if not n.selected_value %}selected{% endif %}>— Please select —</option>
              {% if n.scope_choices is defined and n.scope_choices|length > 0 %}
                {% for val in n.scope_choices %}
                  <option value="{{ val }}" {% if val == n.selected_value %}selected{% endif %}>{{ val }}</option>
                {% endfor %}
              {% elif n.selected_value %}
                <option value="{{ n.selected_value }}" selected>{{ n.selected_value }}</option>
              {% endif %}
            </select>

            <!-- Result count display -->
            <span class="result-label {% if n.search_result_list | length > 0 %}green{% else %}red{% endif %}">
              <span>Result:</span>
              <span>{{ n.search_result_list | length }}</span>
            </span>

            <!-- Delete button -->
            <button type="button" class="delete-search-btn"
                    style="padding:0.3rem 0.6rem; background:#dc3545; color:white; border:none; border-radius:4px;">
              ✕
            </button>
          </div>
        {% endif %}
      {% endmacro %}

      <div id="extra-search-fields">
        {% if nodes %}
          {% for n in nodes %}
            {{ render_search_node(n, loop.index0) }}
          {% endfor %}
        {% endif %}
      </div>

      <!-- GLOBAL ADD BUTTONS -->
      <div id="global-add-buttons" style="margin-top:2rem; display:flex; gap:0.5rem;">
        <button type="button" id="global-add-complex-search-btn"
                style="padding:0.4rem 1rem;background:#343a40;color:white;border:none;">
            + Komplexe Suche (AND/OR/NOT)
        </button>
        <button type="button" id="global-add-search-btn"
                style="padding:0.4rem 1rem;background:#6c757d;color:white;border:none;">
            + Weitere einfache Suche
        </button>
      </div>

      <button type="submit"
          style="margin-top: 1rem; padding: 0.4rem 1rem; font-size: 1rem; background-color: #0074D9; color: white; border: none;">
          Suchen
      </button>
  </form>

  <!-- Template for additional search bars -->
  <template id="search-template">
    <div class="search-group" style="margin-top:1rem; display:flex; gap:0.5rem; align-items:center;">

      <!-- Left dropdown – values come from the Enum -->
      <select name="selected_type" class="search-konkordanz-dropdown">
        <option value="" selected>— Type —</option>
        {% for ft in filter_node_groups %}
          <option value="{{ ft.value }}">{{ ft.name.title().replace('_', ' ') }}</option>
        {% endfor %}
      </select>

      <!-- Search bar -->
      <div class="search-konkordanz-bar" style="display:flex; align-items:center; gap:0.5rem;">
        <input type="text"
              name="keyword"
              class="search-konkordanz-input"
              placeholder="Suchbegriff...">

        <div class="search-konkordanz-options">
          <span class="search-toggle" title="Groß-/Kleinschreibung">Aa</span>
          <span class="search-toggle" title="Nur ganze Wörter suchen">ab|</span>
          <span class="search-toggle" title="Regulären Ausdruck verwenden">.*</span>
        </div>

        <!-- Hidden toggles: keep names with [] so the JS can identify and rename them -->
        <input type="checkbox" class="hidden-toggle" name="case_sensitive[]" value="1">
        <input type="checkbox" class="hidden-toggle" name="whole_word[]"     value="1">
        <input type="checkbox" class="hidden-toggle" name="use_regex[]"      value="1">
      </div>

      <!-- Right dropdown – dynamic -->
      <select name="selected_scope" class="search-konkordanz-dropdown">

      </select>

      <!-- 🗑️ Delete button -->
      <button type="button" class="delete-search-btn"
              style="padding:0.3rem 0.6rem; background:#dc3545; color:white; border:none; border-radius:4px;">
        ✕
      </button>
    </div>
  </template>

<!-- Template for complex search bar -->
<template id="complex-search-template">
  <div class="complex-search-group" style="margin-top:1rem; display:flex; flex-direction:column; gap:0.5rem; padding:0.5rem 0.5rem; border-radius:6px; border:1px solid #e0e0e0;">
    <div style="display:flex; gap:0.5rem; align-items:center;">
      <label for="logic-operator" style="font-weight:bold;">Logik:</label>
      <select name="logic_operator" class="logic-operator-dropdown">
        <option value="AND">AND</option>
        <option value="OR">OR</option>
        <option value="NOT">NOT</option>
      </select>
      <button type="button" class="delete-complex-search-btn"
              style="padding:0.3rem 0.6rem; background:#dc3545; color:white; border:none; border-radius:4px;">
        ✕
      </button>
    </div>
    <!-- Child container for tree view -->
    <div class="grouped-searches"></div>
  </div>
</template>
</div>
{% endblock %}

{% block scripts %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/konkordanz_custom.css') }}">
  <script src="{{ url_for('static', filename='js/konkordanz.js') }}"></script>
{% endblock %}

