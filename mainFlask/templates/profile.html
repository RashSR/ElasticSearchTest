{% extends "layout.html" %}

{% block content %}

{% if author %}
<div class="profile-card">
    <div class="profile-avatar">{{ author.name[0] }}</div>
    <h2>{{ author.name }}</h2>
    <p><strong>Alter:</strong> {{ author.age or "Unbekannt" }}</p>
    <p><strong>Geschlecht:</strong> {{ author.gender or "Nicht angegeben" }}</p>
    <p><strong>Muttersprache:</strong> {{ author.first_language or "Nicht angegeben" }}</p>
    <p><strong>Weitere Sprachen:</strong> {{ author.languages | join(', ') if author.languages else "Keine" }}</p>
    <p><strong>Region:</strong> {{ author.region or "Nicht angegeben" }}</p>
    <p><strong>Beruf:</strong> {{ author.job or "Nicht angegeben" }}</p>
    <p><strong>Anzahl Chats: </strong> {{ author.chat_ids | length }}</p>
    <button id="add-chat-btn" style="margin-top:0.5rem; padding:0.4rem 1rem; background:#0074D9; color:white; border:none; border-radius:4px; cursor:pointer; font-size:1em;">Chat hinzufügen</button>
    <script>
    document.getElementById('add-chat-btn').addEventListener('click', function() {
      fetch(`/profile/{{ author.id }}/add_chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => {
        if (r.ok) {
          location.reload();
        } else {
          alert('Fehler beim Hinzufügen des Chats!');
        }
      });
    });
    </script>
    <div style="margin-top:1.5rem;">
        <label for="annotation-box"><strong>Annotation:</strong></label><br>
        <textarea id="annotation-box" class="annotation-box" rows="3" readonly>{{ author.annotation or '' }}</textarea>
        <div style="font-size:0.9em;color:#888;">(Klick zum Bearbeiten, Enter oder Klick außerhalb speichert)</div>
        <script>
        const annotationBox = document.getElementById('annotation-box');
        let lastValue = annotationBox.value;
        annotationBox.addEventListener('click', function() {
          if (annotationBox.hasAttribute('readonly')) {
            annotationBox.removeAttribute('readonly');
            annotationBox.focus();
          }
        });
        annotationBox.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            annotationBox.blur();
          }
        });
        annotationBox.addEventListener('blur', function() {
          annotationBox.setAttribute('readonly', 'readonly');
          if (annotationBox.value !== lastValue) {
            fetch(window.location.pathname + '/annotation', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ annotation: annotationBox.value })
            }).then(r => {
              if (!r.ok) alert('Fehler beim Speichern!');
              else lastValue = annotationBox.value;
            });
          }
        });
        </script>
        <script>
        const annotationBox = document.getElementById('annotation-box');
        let lastValue = annotationBox.value;
        annotationBox.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            annotationBox.blur();
          }
        });
        annotationBox.addEventListener('blur', function() {
          annotationBox.setAttribute('readonly', 'readonly');
          if (annotationBox.value !== lastValue) {
            fetch(window.location.pathname + '/annotation', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ annotation: annotationBox.value })
            }).then(r => {
              if (!r.ok) alert('Fehler beim Speichern!');
              else lastValue = annotationBox.value;
            });
          }
        });
        </script>
    </div>
</div>
{% else %}
    <div class="no-element-selected">
        <p style="text-align: center; margin-top: 40px; color: #777;">
            Wähle einen Autor aus der Liste links aus.
        </p>
    </div>
{% endif %}
{% endblock %}
