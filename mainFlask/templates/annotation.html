{% extends "layout.html" %}

<style>
    .selectable.selected {
        box-shadow: 0 0 0 3px #0074D9;
        background: #cce4ff !important;
        border: 2px solid #0074D9 !important;
        color: #003366 !important;
        z-index: 1;
    }
</style>
{% block content %}
{% if message %}
<div style="padding: 2rem; font-size: 1.2rem;">
    <label for="annotated-text" style="font-weight:bold;">Annotierter Text:</label>
    <div id="annotated-text" data-message-id="{{ message.message_id }}" style="width:100%; font-size:1rem; padding:0.5rem; background:#f8f9fa; border:1px solid #ccc; border-radius:4px; min-height:6em;">
        {{ message.annotated_text | safe }}
    </div>
    <div id="add-annotation-form-container" style="display:none; margin:2em 0 1em 0;"></div>

    <div style="margin-top:1.5rem;">
        <div id="annotation-header" style="font-weight:bold; font-size:1.1rem; cursor:pointer; background:#e9ecef; padding:0.5em 0.8em; border-radius:4px; user-select:none; display:flex; align-items:center; justify-content:space-between;">
            <div style="display:flex; align-items:center; gap:0.7em;">
                <input type="checkbox" class="header-checkbox annotation-header-checkbox" style="margin-right:0.7em;" />
                <span>Manuelle Annotationen ({{ message.annotations|length if message.annotations else 0 }}) ▶</span>
            </div>
            <button type="button" class="add-annotation-btn" style="padding:0.2em 0.9em; background:#0074D9; color:white; border:none; border-radius:3px; font-size:1em; cursor:pointer;">Hinzufügen</button>
        </div>
        <div id="annotation-list" style="margin-top:0.5rem; display:none;">
        {% if message.annotations and message.annotations|length > 0 %}
            <ul style="padding-left:1.2em; max-height:14em; overflow-y:auto; resize:vertical; min-height:3em; scrollbar-width:thick;">
            {% for ann in message.annotations %}
                <li class="selectable annotation-item" style="margin-bottom:0.7em; background:#f1f1f1; border-radius:4px; padding:0.5em; display:flex; align-items:center; gap:0.7em; cursor:pointer;" data-annotation-id="{{ ann.id }}">
                    <input type="checkbox" class="select-checkbox" style="margin-right:0.7em;" />
                    <div style="flex:1;">
                        <strong>Position:</strong>
                        <input type="number" class="annotation-start" value="{{ ann.start_pos }}" style="width:4em; padding:0.2em; border:1px solid #ccc; border-radius:3px; font-size:1em;" min="0" />
                        -
                        <input type="number" class="annotation-end" value="{{ ann.end_pos }}" style="width:4em; padding:0.2em; border:1px solid #ccc; border-radius:3px; font-size:1em;" min="0" /><br>
                        <strong>Annotation:</strong>
                        <input type="text" class="annotation-text" value="{{ ann.annotation }}" style="padding:0.2em; border:1px solid #ccc; border-radius:3px; font-size:1em; width:auto; min-width:2em;" /><br>
                        <strong>Grund:</strong>
                        <input type="text" class="annotation-grund" value="{{ ann.reason }}" style="padding:0.2em; border:1px solid #ccc; border-radius:3px; font-size:1em; width:auto; min-width:2em;" /><br>
                        <strong>Kommentar:</strong>
                        <input type="text" name="comment_{{ loop.index0 }}" value="{{ ann.comment }}" style="padding:0.2em; border:1px solid #ccc; border-radius:3px; font-size:1em; width:auto; min-width:2em;" oninput="this.style.width = ((this.value.length + 1) * 0.7) + 'em';" />
                    </div>
                    <button type="button" class="save-annotation-btn" style="padding:0.2em 0.7em; background:#0074D9; color:white; border:none; border-radius:3px; font-size:1em; cursor:pointer;">Speichern</button>
                    <button type="button" class="delete-annotation-btn" style="padding:0.2em 0.7em; background:#dc3545; color:white; border:none; border-radius:3px; font-size:1em; cursor:pointer;">Löschen</button>
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p style="color:#888;">Keine manuellen Annotationen vorhanden.</p>
        {% endif %}
        </div>

        <div id="error-header" style="font-weight:bold; font-size:1.1rem; cursor:pointer; background:#ffecec; padding:0.5em 0.8em; border-radius:4px; user-select:none; margin-top:1.2em; display:flex; align-items:center; justify-content:space-between;">
            <div style="display:flex; align-items:center; gap:0.7em;">
                <input type="checkbox" class="header-checkbox error-header-checkbox" style="margin-right:0.7em;" />
                <span>Fehlerliste ({{ message.error_list|length if message.error_list else 0 }}) ▶</span>
            </div>
        </div>
        <div id="error-list" style="margin-top:0.5rem; display:none;">
        {% if message.error_list and message.error_list|length > 0 %}
            <ul style="padding-left:1.2em; max-height:14em; overflow-y:auto; resize:vertical; min-height:3em; scrollbar-width:thick;">
            {% for err in message.error_list %}
                {# Expecting err to be a dict/object with keys: start_pos, end_pos, category, rule_id, message #}
                <li class="selectable error-item" data-id="{{ err.id }}" style="margin-bottom:0.7em; background:#ffecec; border-radius:4px; padding:0.5em; display:flex; align-items:center; gap:0.7em; color:#b30000; cursor:pointer;">
                    <input type="checkbox" class="select-checkbox" style="margin-right:0.7em;" />
                    <div style="flex:1;">
                        <div><strong>Position:</strong> <span class="error-start">{{ err.start_pos }}</span> - <span class="error-end">{{ err.end_pos }}</span></div>
                        <div><strong>Kategorie:</strong>
                            <select class="error-category-dropdown search-konkordanz-dropdown" data-current="{{ err.category }}" style="min-width: 110px; max-width: 180px; padding: 0.3rem 0.6rem; border: 1px solid #ced4da; border-radius: 4px; background: #fff;">
                                <option value="{{ err.category }}" selected>{{ err.category }}</option>
                            </select>
                        </div>
                                                <div><strong>Regel-ID:</strong>
                                                    <select class="error-ruleid-dropdown search-konkordanz-dropdown" data-current="{{ err.rule_id }}" style="min-width: 110px; max-width: 180px; padding: 0.3rem 0.6rem; border: 1px solid #ced4da; border-radius: 4px; background: #fff;">
                                                        <option value="{{ err.rule_id }}" selected>{{ err.rule_id }}</option>
                                                    </select>
                                                </div>
                    </div>
                    <button type="button" class="save-error-btn" style="padding:0.2em 0.7em; background:#0074D9; color:white; border:none; border-radius:3px; font-size:1em; cursor:pointer;">Speichern</button>
                    <button type="button" class="delete-error-btn" style="padding:0.2em 0.7em; background:#dc3545; color:white; border:none; border-radius:3px; font-size:1em; cursor:pointer;">Löschen</button>
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p style="color:#888;">Keine Fehler vorhanden.</p>
        {% endif %}
        </div>

        <div id="spacy-header" style="font-weight:bold; font-size:1.1rem; cursor:pointer; background:#e0f7fa; padding:0.5em 0.8em; border-radius:4px; user-select:none; margin-top:1.2em; display:flex; align-items:center; justify-content:space-between;">
            <div style="display:flex; align-items:center; gap:0.7em;">
                <input type="checkbox" class="header-checkbox spacy-header-checkbox" style="margin-right:0.7em;" />
                <span>Linguistische Attribute ({{ message.spacy_matches|length if message.spacy_matches else 0 }}) ▶</span>
            </div>
        </div>
        <div id="spacy-list" style="margin-top:0.5rem; display:none;">
        {% if message.spacy_matches and message.spacy_matches|length > 0 %}
            <ul style="padding-left:1.2em; max-height:30em; overflow-y:auto; resize:vertical; min-height:3em; scrollbar-width:thick;">
            {% for match in message.spacy_matches %}
                <li class="selectable spacy-item" data-id="{{ match.id }}" style="margin-bottom:0.7em; background:#e0f7fa; border-radius:4px; padding:0.5em; color:#00796b; cursor:pointer; display:flex; align-items:center; gap:0.7em;">
                    <input type="checkbox" class="select-checkbox" style="margin-right:0.7em;" />
                    <div style="flex:1; display:flex; flex-direction:column; gap:0.2em;">
                        <span><strong>Start Pos:</strong> <span class="spacy-start">{{ match.start_pos if match.start_pos is defined else '-' }}</span></span>
                        <span><strong>End Pos:</strong> <span class="spacy-end">{{ match.end_pos if match.end_pos is defined else '-' }}</span></span>
                        <span><strong>Text:</strong> <span class="spacy-text" data-text="{{ match.text|e if match.text is defined else '' }}">{{ match.text if match.text is defined else '-' }}</span></span>
                        <span><strong>Lemma:</strong> <span class="spacy-lemma">{{ match.lemma if match.lemma is defined else '-' }}</span></span>
                        <span style="display:inline-flex; align-items:center; margin-right:0.7em;"><strong>POS:</strong>
                            <select class="spacy-pos-dropdown spacy-dropdown" data-current="{{ match.pos|default('') }}" style="margin-left:0.5em; min-width:6em; border-radius:4px; padding:0.2em 0.5em; border:1px solid #bbb; background:#f8f8ff; font-size:1em; height:2em;"></select>
                        </span>
                        <span style="display:inline-flex; align-items:center; margin-right:0.7em;"><strong>Tag:</strong>
                            <select class="spacy-tag-dropdown spacy-dropdown" data-current="{{ match.tag|default('') }}" style="margin-left:0.5em; min-width:6em; border-radius:4px; padding:0.2em 0.5em; border:1px solid #bbb; background:#f8f8ff; font-size:1em; height:2em;"></select>
                        </span>
                        <span style="display:inline-flex; align-items:center; margin-right:0.7em;"><strong>Alpha:</strong>
                            <select class="spacy-alpha-dropdown spacy-dropdown" data-current="{{ match.is_alpha|default('') }}" style="margin-left:0.5em; min-width:6em; border-radius:4px; padding:0.2em 0.5em; border:1px solid #bbb; background:#f8f8ff; font-size:1em; height:2em;"></select>
                        </span>
                        <span style="display:inline-flex; align-items:center; margin-right:0.7em;"><strong>Stopwort:</strong>
                            <select class="spacy-stop-dropdown spacy-dropdown" data-current="{{ match.is_stop|default('') }}" style="margin-left:0.5em; min-width:6em; border-radius:4px; padding:0.2em 0.5em; border:1px solid #bbb; background:#f8f8ff; font-size:1em; height:2em;"></select>
                        </span>
                        <span style="display:inline-flex; align-items:center; margin-right:0.7em;"><strong>Tense:</strong>
                            <select class="spacy-tense-dropdown spacy-dropdown" data-current="{{ match.tense|default('') }}" style="margin-left:0.5em; min-width:6em; border-radius:4px; padding:0.2em 0.5em; border:1px solid #bbb; background:#f8f8ff; font-size:1em; height:2em;"></select>
                        </span>
                        <span style="display:inline-flex; align-items:center; margin-right:0.7em;"><strong>Person:</strong>
                            <select class="spacy-person-dropdown spacy-dropdown" data-current="{{ match.person|default('') }}" style="margin-left:0.5em; min-width:6em; border-radius:4px; padding:0.2em 0.5em; border:1px solid #bbb; background:#f8f8ff; font-size:1em; height:2em;"></select>
                        </span>
                        <span style="display:inline-flex; align-items:center; margin-right:0.7em;"><strong>Verbform:</strong>
                            <select class="spacy-verbform-dropdown spacy-dropdown" data-current="{{ match.verb_form|default('') }}" style="margin-left:0.5em; min-width:6em; border-radius:4px; padding:0.2em 0.5em; border:1px solid #bbb; background:#f8f8ff; font-size:1em; height:2em;"></select>
                        </span>
                        <span style="display:inline-flex; align-items:center; margin-right:0.7em;"><strong>Voice:</strong>
                            <select class="spacy-voice-dropdown spacy-dropdown" data-current="{{ match.voice|default('') }}" style="margin-left:0.5em; min-width:6em; border-radius:4px; padding:0.2em 0.5em; border:1px solid #bbb; background:#f8f8ff; font-size:1em; height:2em;"></select>
                        </span>
                        <span style="display:inline-flex; align-items:center; margin-right:0.7em;"><strong>Degree:</strong>
                            <select class="spacy-degree-dropdown spacy-dropdown" data-current="{{ match.degree|default('') }}" style="margin-left:0.5em; min-width:6em; border-radius:4px; padding:0.2em 0.5em; border:1px solid #bbb; background:#f8f8ff; font-size:1em; height:2em;"></select>
                        </span>
                        <span style="display:inline-flex; align-items:center; margin-right:0.7em;"><strong>Case:</strong>
                            <select class="spacy-case-dropdown spacy-dropdown" data-current="{{ match.gram_case|default('') }}" style="margin-left:0.5em; min-width:6em; border-radius:4px; padding:0.2em 0.5em; border:1px solid #bbb; background:#f8f8ff; font-size:1em; height:2em;"></select>
                        </span>
                        <span style="display:inline-flex; align-items:center; margin-right:0.7em;"><strong>Number:</strong>
                            <select class="spacy-number-dropdown spacy-dropdown" data-current="{{ match.number|default('') }}" style="margin-left:0.5em; min-width:6em; border-radius:4px; padding:0.2em 0.5em; border:1px solid #bbb; background:#f8f8ff; font-size:1em; height:2em;"></select>
                        </span>
                        <span style="display:inline-flex; align-items:center; margin-right:0.7em;"><strong>Gender:</strong>
                            <select class="spacy-gender-dropdown spacy-dropdown" data-current="{{ match.gender|default('') }}" style="margin-left:0.5em; min-width:6em; border-radius:4px; padding:0.2em 0.5em; border:1px solid #bbb; background:#f8f8ff; font-size:1em; height:2em;"></select>
                        </span>
                        <span style="display:inline-flex; align-items:center; margin-right:0.7em;"><strong>Mood:</strong>
                            <select class="spacy-mood-dropdown spacy-dropdown" data-current="{{ match.mood|default('') }}" style="margin-left:0.5em; min-width:6em; border-radius:4px; padding:0.2em 0.5em; border:1px solid #bbb; background:#f8f8ff; font-size:1em; height:2em;"></select>
                        </span>
                        <span style="display:inline-flex; align-items:center; margin-right:0.7em;"><strong>PronType:</strong>
                            <select class="spacy-prontype-dropdown spacy-dropdown" data-current="{{ match.pron_type|default('') }}" style="margin-left:0.5em; min-width:6em; border-radius:4px; padding:0.2em 0.5em; border:1px solid #bbb; background:#f8f8ff; font-size:1em; height:2em;"></select>
                        </span>
                    </div>
                    <button type="button" class="save-spacy-btn" style="padding:0.2em 0.7em; background:#0074D9; color:white; border:none; border-radius:3px; font-size:1em; cursor:pointer;">Speichern</button>
                    <button type="button" class="delete-spacy-btn" style="margin-left:auto; padding:0.2em 0.7em; background:#dc3545; color:white; border:none; border-radius:3px; font-size:1em; cursor:pointer;">Löschen</button>
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p style="color:#888;">Keine linguistischen Attribute vorhanden.</p>
        {% endif %}
        </div>
    </div>
{% else %}
<div style="margin-top:2em; padding:1.2em; background:#ffecec; color:#b30000; border-radius:6px; text-align:center; font-size:1.1em;">
    <i class="fas fa-info-circle" style="margin-right:0.5em;"></i>
    Es ist keine gültige Nachricht ausgewählt. Bitte wählen Sie eine Nachricht aus, um die Annotationen zu sehen.
</div>
{% endif %}
{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='js/annotation.js') }}"></script>
{% endblock %}

