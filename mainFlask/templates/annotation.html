{% extends "layout.html" %}

{% block content %}
<div style="padding: 2rem; font-size: 1.2rem;">
    <label for="annotated-text" style="font-weight:bold;">Annotierter Text:</label>
    <div id="annotated-text" style="width:100%; font-size:1rem; padding:0.5rem; background:#f8f9fa; border:1px solid #ccc; border-radius:4px; min-height:6em;">
        {{ message.annotated_text | safe }}
    </div>

    <div style="margin-top:1.5rem;">
        <div id="annotation-header" style="font-weight:bold; font-size:1.1rem; cursor:pointer; background:#e9ecef; padding:0.5em 0.8em; border-radius:4px; user-select:none; display:flex; align-items:center; justify-content:space-between;">
            <span>Manuelle Annotationen ({{ message.annotations|length if message.annotations else 0 }}) ▶</span>
            <button type="button" class="add-annotation-btn" style="padding:0.2em 0.9em; background:#0074D9; color:white; border:none; border-radius:3px; font-size:1em; cursor:pointer;">Hinzufügen</button>
        </div>
        <div id="annotation-list" style="margin-top:0.5rem; display:none;">
        {% if message.annotations and message.annotations|length > 0 %}
            <ul style="padding-left:1.2em; max-height:14em; overflow-y:auto; resize:vertical; min-height:3em; scrollbar-width:thick;">
            {% for ann in message.annotations %}
                <li style="margin-bottom:0.7em; background:#f1f1f1; border-radius:4px; padding:0.5em; display:flex; align-items:center; gap:0.7em;" data-annotation-id="{{ ann.id }}">
                    <div style="flex:1;">
                        <strong>Position:</strong> <span class="annotation-start">{{ ann.start_pos }}</span> - <span class="annotation-end">{{ ann.end_pos }}</span><br>
                        <strong>Annotation:</strong> <span class="annotation-text">{{ ann.annotation }}</span><br>
                        <strong>Grund:</strong> <span class="annotation-grund">{{ ann.reason }}</span><br>
                        <strong>Kommentar:</strong>
                        <input type="text" name="comment_{{ loop.index0 }}" value="{{ ann.comment }}" style="padding:0.2em; border:1px solid #ccc; border-radius:3px; font-size:1em; width:auto; min-width:2em;" oninput="this.style.width = ((this.value.length + 1) * 0.7) + 'em';" />
                    </div>
                    <button type="button" class="save-annotation-btn" style="padding:0.2em 0.7em; background:#0074D9; color:white; border:none; border-radius:3px; font-size:1em; cursor:pointer;">Speichern</button>
                    <button type="button" class="delete-annotation-btn" style="padding:0.2em 0.7em; background:#dc3545; color:white; border:none; border-radius:3px; font-size:1em; cursor:pointer;">Löschen</button>
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p style="color:#888;">Keine manuellen Annotationen vorhanden.</p>
        {% endif %}
        </div>

        <div id="error-header" style="font-weight:bold; font-size:1.1rem; cursor:pointer; background:#ffecec; padding:0.5em 0.8em; border-radius:4px; user-select:none; margin-top:1.2em; display:flex; align-items:center; justify-content:space-between;">
            <span>Fehlerliste ({{ message.error_list|length if message.error_list else 0 }}) ▶</span>
            <button type="button" class="add-error-btn" style="padding:0.2em 0.9em; background:#0074D9; color:white; border:none; border-radius:3px; font-size:1em; cursor:pointer;">Hinzufügen</button>
        </div>
        <div id="error-list" style="margin-top:0.5rem; display:none;">
        {% if message.error_list and message.error_list|length > 0 %}
            <ul style="padding-left:1.2em; max-height:14em; overflow-y:auto; resize:vertical; min-height:3em; scrollbar-width:thick;">
            {% for err in message.error_list %}
                {# Expecting err to be a dict/object with keys: start_pos, end_pos, category, rule_id, message #}
                <li style="margin-bottom:0.7em; background:#ffecec; border-radius:4px; padding:0.5em; display:flex; align-items:center; gap:0.7em; color:#b30000;">
                    <div style="flex:1;">
                        <div><strong>Position:</strong> <span class="error-start">{{ err.start_pos }}</span> - <span class="error-end">{{ err.end_pos }}</span></div>
                        <div><strong>Kategorie:</strong> <span class="error-category">{{ err.category }}</span></div>
                        <div><strong>Regel-ID:</strong> <span class="error-rule">{{ err.rule_id }}</span></div>
                    </div>
                    <button type="button" class="delete-error-btn" style="padding:0.2em 0.7em; background:#dc3545; color:white; border:none; border-radius:3px; font-size:1em; cursor:pointer;">Löschen</button>
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p style="color:#888;">Keine Fehler vorhanden.</p>
        {% endif %}
        </div>

        <div id="spacy-header" style="font-weight:bold; font-size:1.1rem; cursor:pointer; background:#e0f7fa; padding:0.5em 0.8em; border-radius:4px; user-select:none; margin-top:1.2em; display:flex; align-items:center; justify-content:space-between;">
            <span>Linguistische Attribute ({{ message.spacy_matches|length if message.spacy_matches else 0 }}) ▶</span>
            <button type="button" class="add-spacy-btn" style="padding:0.2em 0.9em; background:#0074D9; color:white; border:none; border-radius:3px; font-size:1em; cursor:pointer;">Hinzufügen</button>
        </div>
        <div id="spacy-list" style="margin-top:0.5rem; display:none;">
        {% if message.spacy_matches and message.spacy_matches|length > 0 %}
            <ul style="padding-left:1.2em; max-height:14em; overflow-y:auto; resize:vertical; min-height:3em; scrollbar-width:thick;">
            {% for match in message.spacy_matches %}
                <li style="margin-bottom:0.7em; background:#e0f7fa; border-radius:4px; padding:0.5em; color:#00796b;">
                    {{ match }}
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p style="color:#888;">Keine linguistischen Attribute vorhanden.</p>
        {% endif %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    function setupCollapsible(headerId, listId, label) {
        var header = document.getElementById(headerId);
        var list = document.getElementById(listId);
        var arrowSpan = header ? header.querySelector('span') : null;
        var expanded = false;
        if (header && list && arrowSpan) {
            header.addEventListener('click', function(e) {
                // Only toggle if the click is NOT on the Hinzufügen button
                if (e.target.classList.contains('add-annotation-btn') || e.target.classList.contains('add-error-btn') || e.target.classList.contains('add-spacy-btn')) {
                    return;
                }
                expanded = !expanded;
                if (expanded) {
                    list.style.display = '';
                    arrowSpan.innerHTML = arrowSpan.innerHTML.replace('▶', '▼');
                } else {
                    list.style.display = 'none';
                    arrowSpan.innerHTML = arrowSpan.innerHTML.replace('▼', '▶');
                }
            });
        }
    }
    setupCollapsible('annotation-header', 'annotation-list', 'Manuelle Annotationen');
    setupCollapsible('error-header', 'error-list', 'Fehlerliste');
    setupCollapsible('spacy-header', 'spacy-list', 'Linguistische Attribute');

    // Save button logic for annotation comments
    document.querySelectorAll('.save-annotation-btn').forEach(function(btn, idx) {
        btn.addEventListener('click', function() {
            var li = btn.closest('li');
            var input = li.querySelector('input[type="text"][name^="comment_"]');
            var comment = input ? input.value : '';
            // Get annotation_id from a data attribute (add this to your li in the template)
            var annotationId = li.getAttribute('data-annotation-id');
            var grund = li.querySelector('.annotation-grund') ? li.querySelector('.annotation-grund').textContent.trim() : '';
            var annotationText = li.querySelector('.annotation-text') ? li.querySelector('.annotation-text').textContent.trim() : '';
            var startPos = li.querySelector('.annotation-start') ? li.querySelector('.annotation-start').textContent.trim() : '';
            var endPos = li.querySelector('.annotation-end') ? li.querySelector('.annotation-end').textContent.trim() : '';
            btn.disabled = true;
            fetch('/update_annotation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'annotation_id=' + encodeURIComponent(annotationId) +
                      '&new_comment=' + encodeURIComponent(comment) +
                      '&grund=' + encodeURIComponent(grund) +
                      '&annotation=' + encodeURIComponent(annotationText) +
                      '&start_pos=' + encodeURIComponent(startPos) +
                      '&end_pos=' + encodeURIComponent(endPos)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    btn.textContent = 'Gespeichert!';
                    btn.style.background = '#28a745';
                } else {
                    btn.textContent = 'Fehler!';
                    btn.style.background = '#dc3545';
                }
                setTimeout(function() {
                    btn.textContent = 'Speichern';
                    btn.style.background = '#0074D9';
                    btn.disabled = false;
                }, 1200);
            })
            .catch(() => {
                btn.textContent = 'Fehler!';
                setTimeout(function() { btn.textContent = 'Speichern'; btn.disabled = false; }, 1200);
            });
        });
    });

    // Delete button logic for annotation
    document.querySelectorAll('.delete-annotation-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var li = btn.closest('li');
            var annotationId = li.getAttribute('data-annotation-id');
            if (!annotationId) {
                alert('Annotation ID fehlt!');
                return;
            }
            btn.disabled = true;
            fetch('/delete_annotation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'annotation_id=' + encodeURIComponent(annotationId)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    li.remove();
                } else {
                    btn.textContent = 'Fehler!';
                    setTimeout(function() { btn.textContent = 'Löschen'; btn.disabled = false; }, 1200);
                }
            })
            .catch(() => {
                btn.textContent = 'Fehler!';
                setTimeout(function() { btn.textContent = 'Löschen'; btn.disabled = false; }, 1200);
            });
        });
    });
});
</script>
{% endblock %}

{% block styles %}
<style>
ul[style*="resize:vertical"]::-webkit-scrollbar {
    width: 16px;
}
ul[style*="resize:vertical"]::-webkit-scrollbar-thumb {
    background: #bbb;
    border-radius: 8px;
}
ul[style*="resize:vertical"] {
    min-height: 3em;
    max-height: 30em;
}
</style>
{% endblock %}