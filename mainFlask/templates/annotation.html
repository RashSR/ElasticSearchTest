{% extends "layout.html" %}

<style>
    .selectable.selected {
        box-shadow: 0 0 0 3px #0074D9;
        background: #cce4ff !important;
        border: 2px solid #0074D9 !important;
        color: #003366 !important;
        z-index: 1;
    }
</style>
{% block content %}
<div style="padding: 2rem; font-size: 1.2rem;">
    <label for="annotated-text" style="font-weight:bold;">Annotierter Text:</label>
    <div id="annotated-text" style="width:100%; font-size:1rem; padding:0.5rem; background:#f8f9fa; border:1px solid #ccc; border-radius:4px; min-height:6em;">
        {{ message.annotated_text | safe }}
    </div>

    <div style="margin-top:1.5rem;">
        <div id="annotation-header" style="font-weight:bold; font-size:1.1rem; cursor:pointer; background:#e9ecef; padding:0.5em 0.8em; border-radius:4px; user-select:none; display:flex; align-items:center; justify-content:space-between;">
            <span>Manuelle Annotationen ({{ message.annotations|length if message.annotations else 0 }}) ▶</span>
            <div style="display:flex; align-items:center; gap:0.7em;">
                <input type="checkbox" class="header-checkbox annotation-header-checkbox" style="margin-right:0.7em;" />
                <button type="button" class="add-annotation-btn" style="padding:0.2em 0.9em; background:#0074D9; color:white; border:none; border-radius:3px; font-size:1em; cursor:pointer;">Hinzufügen</button>
            </div>
        </div>
        <div id="annotation-list" style="margin-top:0.5rem; display:none;">
        {% if message.annotations and message.annotations|length > 0 %}
            <ul style="padding-left:1.2em; max-height:14em; overflow-y:auto; resize:vertical; min-height:3em; scrollbar-width:thick;">
            {% for ann in message.annotations %}
                <li class="selectable annotation-item" style="margin-bottom:0.7em; background:#f1f1f1; border-radius:4px; padding:0.5em; display:flex; align-items:center; gap:0.7em; cursor:pointer;" data-annotation-id="{{ ann.id }}">
                    <input type="checkbox" class="select-checkbox" style="margin-right:0.7em;" />
                    <div style="flex:1;">
                        <strong>Position:</strong> <span class="annotation-start">{{ ann.start_pos }}</span> - <span class="annotation-end">{{ ann.end_pos }}</span><br>
                        <strong>Annotation:</strong> <span class="annotation-text">{{ ann.annotation }}</span><br>
                        <strong>Grund:</strong> <span class="annotation-grund">{{ ann.reason }}</span><br>
                        <strong>Kommentar:</strong>
                        <input type="text" name="comment_{{ loop.index0 }}" value="{{ ann.comment }}" style="padding:0.2em; border:1px solid #ccc; border-radius:3px; font-size:1em; width:auto; min-width:2em;" oninput="this.style.width = ((this.value.length + 1) * 0.7) + 'em';" />
                    </div>
                    <button type="button" class="save-annotation-btn" style="padding:0.2em 0.7em; background:#0074D9; color:white; border:none; border-radius:3px; font-size:1em; cursor:pointer;">Speichern</button>
                    <button type="button" class="delete-annotation-btn" style="padding:0.2em 0.7em; background:#dc3545; color:white; border:none; border-radius:3px; font-size:1em; cursor:pointer;">Löschen</button>
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p style="color:#888;">Keine manuellen Annotationen vorhanden.</p>
        {% endif %}
        </div>

        <div id="error-header" style="font-weight:bold; font-size:1.1rem; cursor:pointer; background:#ffecec; padding:0.5em 0.8em; border-radius:4px; user-select:none; margin-top:1.2em; display:flex; align-items:center; justify-content:space-between;">
            <span>Fehlerliste ({{ message.error_list|length if message.error_list else 0 }}) ▶</span>
            <div style="display:flex; align-items:center; gap:0.7em;">
                <input type="checkbox" class="header-checkbox error-header-checkbox" style="margin-right:0.7em;" />
                <button type="button" class="add-error-btn" style="padding:0.2em 0.9em; background:#0074D9; color:white; border:none; border-radius:3px; font-size:1em; cursor:pointer;">Hinzufügen</button>
            </div>
        </div>
        <div id="error-list" style="margin-top:0.5rem; display:none;">
        {% if message.error_list and message.error_list|length > 0 %}
            <ul style="padding-left:1.2em; max-height:14em; overflow-y:auto; resize:vertical; min-height:3em; scrollbar-width:thick;">
            {% for err in message.error_list %}
                {# Expecting err to be a dict/object with keys: start_pos, end_pos, category, rule_id, message #}
                <li class="selectable error-item" style="margin-bottom:0.7em; background:#ffecec; border-radius:4px; padding:0.5em; display:flex; align-items:center; gap:0.7em; color:#b30000; cursor:pointer;">
                    <input type="checkbox" class="select-checkbox" style="margin-right:0.7em;" />
                    <div style="flex:1;">
                        <div><strong>Position:</strong> <span class="error-start">{{ err.start_pos }}</span> - <span class="error-end">{{ err.end_pos }}</span></div>
                        <div><strong>Kategorie:</strong> <span class="error-category">{{ err.category }}</span></div>
                        <div><strong>Regel-ID:</strong> <span class="error-rule">{{ err.rule_id }}</span></div>
                    </div>
                    <button type="button" class="delete-error-btn" style="padding:0.2em 0.7em; background:#dc3545; color:white; border:none; border-radius:3px; font-size:1em; cursor:pointer;">Löschen</button>
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p style="color:#888;">Keine Fehler vorhanden.</p>
        {% endif %}
        </div>

        <div id="spacy-header" style="font-weight:bold; font-size:1.1rem; cursor:pointer; background:#e0f7fa; padding:0.5em 0.8em; border-radius:4px; user-select:none; margin-top:1.2em; display:flex; align-items:center; justify-content:space-between;">
            <span>Linguistische Attribute ({{ message.spacy_matches|length if message.spacy_matches else 0 }}) ▶</span>
            <div style="display:flex; align-items:center; gap:0.7em;">
                <input type="checkbox" class="header-checkbox spacy-header-checkbox" style="margin-right:0.7em;" />
                <button type="button" class="add-spacy-btn" style="padding:0.2em 0.9em; background:#0074D9; color:white; border:none; border-radius:3px; font-size:1em; cursor:pointer;">Hinzufügen</button>
            </div>
        </div>
        <div id="spacy-list" style="margin-top:0.5rem; display:none;">
        {% if message.spacy_matches and message.spacy_matches|length > 0 %}
            <ul style="padding-left:1.2em; max-height:14em; overflow-y:auto; resize:vertical; min-height:3em; scrollbar-width:thick;">
            {% for match in message.spacy_matches %}
                <li class="selectable spacy-item" style="margin-bottom:0.7em; background:#e0f7fa; border-radius:4px; padding:0.5em; color:#00796b; cursor:pointer;">
                    <input type="checkbox" class="select-checkbox" style="margin-right:0.7em;" />
                    {{ match }}
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p style="color:#888;">Keine linguistischen Attribute vorhanden.</p>
        {% endif %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='js/annotation.js') }}"></script>
{% endblock %}

{% block styles %}
<style>
ul[style*="resize:vertical"]::-webkit-scrollbar {
    width: 16px;
}
ul[style*="resize:vertical"]::-webkit-scrollbar-thumb {
    background: #bbb;
    border-radius: 8px;
}
ul[style*="resize:vertical"] {
    min-height: 3em;
    max-height: 30em;
}
</style>
{% endblock %}

