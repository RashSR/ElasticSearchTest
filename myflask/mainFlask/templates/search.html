{% extends "layout.html" %}

{% block content %}
<div class="search-container" style="padding: 2rem;">
    <form method="GET" action="{{ url_for('search_view') }}" class="search-bar" style="margin-bottom: 2rem;">
        <input type="text" name="query" placeholder="Nachricht durchsuchen..." value="{{ request.args.get('query', '') }}" required style="padding: 0.5rem; width: 300px;">

        <select name="sender.name" style="padding: 0.5rem;">
            <option value="">Alle Absender</option>
            {% for s in all_senders %}
                <option value="{{ s }}" {% if s == selected_sender %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
        </select>

        <button type="submit" style="padding: 0.5rem 1rem;">Suchen</button>
    </form>

    <label style="display: block; margin-bottom: 1rem;">
        <input type="checkbox" id="toggle-annotation" />
        Annotierte Ansicht anzeigen
    </label>

    {% if results is not none %}
        <div class="chat-box" id="chat-box" style="max-height: 80vh; overflow-y: auto;">
            {% if results %}
                {% set ns = namespace(previous_date=None) %}
                {% for message in results %}
                    {% set message_date = message.timestamp.date() %}
                    {% if message_date != ns.previous_date %}
                        <div class="date-divider" style="text-align: center; margin: 1rem 0; color: #888;">
                            {{ message.timestamp.strftime('%A, %d. %B %Y') }}
                        </div>
                        {% set ns.previous_date = message_date %}
                    {% endif %}

                    <div class="message {{ 'sent' if message.sender.name == author.name else 'received' }}">
                        <div class="text message-highlighted" style="display: block;">
                            {{ message.highlighted_content | safe }}
                        </div>
                        <div class="text message-annotated" style="display: none;">
                            {{ message.annotated_text | safe }}
                        </div>

                        <div class="show-link" style="margin-top: 0.5rem;">
                            <a href="{{ url_for('chat_view', chat_id=message.chat_id) }}#msg-{{ message.message_id }}" title="Im vollstÃ¤ndigen Chat anzeigen">
                                ðŸ”—
                            </a>
                        </div>
                        <div class="timestamp" style="text-align: right; font-size: 0.75rem; color: #666;">
                            {{ message.timestamp.strftime('%H:%M') }}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p style="text-align: center; color: #777;">Keine Nachrichten mit diesem Suchbegriff gefunden.</p>
            {% endif %}
        </div>
    {% else %}
        <p style="text-align: center; color: #777;"> Gib einen Suchbegriff ein, um Nachrichten zu durchsuchen.</p>
    {% endif %}
</div>
{% endblock %}


{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const checkbox = document.getElementById("toggle-annotation");
    const highlightedElems = document.querySelectorAll(".message-highlighted");
    const annotatedElems = document.querySelectorAll(".message-annotated");

    checkbox.addEventListener("change", function () {
      const showAnnotated = checkbox.checked;
      highlightedElems.forEach(el => el.style.display = showAnnotated ? "none" : "block");
      annotatedElems.forEach(el => el.style.display = showAnnotated ? "block" : "none");
    });
  });
</script>
{% endblock %}