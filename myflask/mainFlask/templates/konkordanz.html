{% extends "layout.html" %}

{% block content %}
<div style="padding: 2rem; font-size: 1rem;">
    <h2 style="margin-bottom: 1rem;">
        <i class="fas fa-align-left"></i> Konkordanzansicht
    </h2>

    {% if keyword %}
        <p>Suchergebnisse für: <strong>{{ keyword }}</strong></p>
    {% endif %}

    {% if results %}
    <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
        <thead>
            <tr>
                <th style="width: 30%; border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">Left Context</th>
                <th style="width: 10%; border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">Hit</th>
                <th style="width: 30%; border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">Right Context</th>
                <th style="width: 20%; border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">Empfänger</th>
            </tr>
        </thead>
        <tbody>
        {% for result in results %}
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ result.left }}</td>
            <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; color: #0074D9; white-space: nowrap;">
                {{ result.matched_word }}
                <a href="{{ url_for('chat_view', chat_id=result.message.chat_id, keyword=keyword) }}#msg-{{ result.message.message_id }}"
                    title="Im vollständigen Chat anzeigen"
                    style="margin-left: 5px; text-decoration: none;">
                    <img src="{{ url_for('static', filename='icons/arrow_out_square.svg') }}" alt="Arrow icon" style="width: 16px; height: 16px;">
                </a>
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ result.right }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                {{ result.message.get_recipient().name }}
                <a href="{{ url_for('author_profile', author_id=result.message.get_recipient().id) }}?no_active_change=1"
                    title="Im vollständigen Chat anzeigen"
                    style="margin-left: 5px; text-decoration: none;">
                    <img src="{{ url_for('static', filename='icons/arrow_out_square.svg') }}" alt="Arrow icon" style="width: 16px; height: 16px;">
                </a>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    {% elif keyword %}
        <p style="margin-top: 1rem; color: #888;">Keine Treffer für "<strong>{{ keyword }}</strong>" gefunden.</p>
    {% endif %}

    <!-- Search Form at the Bottom -->
    <form method="get" action="{{ url_for('konkordanz_view') }}">
        <div class="search-konkordanz-bar">
            <!-- Search Input -->
            <input type="text" name="keyword" value="{{ keyword or '' }}" class="search-konkordanz-input" placeholder="Suchbegriff..." required>

            <!-- Option Toggles -->
            <div class="search-konkordanz-options">
                <label title="Groß-/Kleinschreibung">
                    <input type="checkbox" name="case_sensitive" value="1" {% if case_sensitive %}checked{% endif %}>
                    Aa
                </label>
                <label title="Ganzes Wort">
                    <input type="checkbox" name="whole_word" value="1" {% if whole_word %}checked{% endif %}>
                    ab<span style="border-left: 1px solid #333; padding-left: 2px;">|</span>
                </label>
                <label title="Regulärer Ausdruck">
                    <input type="checkbox" name="use_regex" value="1" {% if use_regex %}checked{% endif %}>
                    .*
                </label>
            </div>
        </div>

        <button type="submit"
            style="margin-top: 1rem; padding: 0.4rem 1rem; font-size: 1rem; background-color: #0074D9; color: white; border: none;">
            Suchen
        </button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.getElementById('toggle-recipient').addEventListener('change', function() {
    const displayStyle = this.checked ? '' : 'none';
    const colIndex = 3; // Recipient column is 4th column, so index 3 (zero-based)
    
    document.querySelectorAll(`table th:nth-child(${colIndex + 1})`).forEach(th => {
      th.style.display = displayStyle;
    });
    document.querySelectorAll(`table td:nth-child(${colIndex + 1})`).forEach(td => {
      td.style.display = displayStyle;
    });
  });
</script>
{% endblock %}
