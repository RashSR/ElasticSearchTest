{% extends "layout.html" %}

{% block content %}
<div style="padding: 2rem; font-size: 1rem;">
  <h2 style="margin-bottom: 1rem;">
    <i class="fas fa-align-left"></i> Konkordanzansicht
  </h2>

  {% if keyword %}
      <p>Suchergebnisse f√ºr: <strong>{{ keyword }}</strong></p>
  {% endif %}

  {% if results %}
  <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
    <thead>
      <tr>
        <th style="width: 30%; border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">Left Context</th>
        <th style="width: 10%; border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">Hit</th>
        <th style="width: 30%; border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">Right Context</th>
        <th style="width: 20%; border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">Empf√§nger</th>
      </tr>
    </thead>
    <tbody>
      {% for result in results %}
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">{{ result.left }}</td>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; color: #0074D9; white-space: nowrap;">
          {{ result.matched_word }}
          <a href="{{ url_for('chat_view', chat_id=result.message.chat_id, keyword=keyword) }}#msg-{{ result.message.message_id }}"
            title="Im vollst√§ndigen Chat anzeigen"
            style="margin-left: 5px; text-decoration: none;">
            <img src="{{ url_for('static', filename='icons/arrow_out_square.svg') }}" alt="Arrow icon" style="width: 16px; height: 16px;">
          </a>
        </td>
        <td style="border: 1px solid #ddd; padding: 8px;">{{ result.right }}</td>
        <td style="border: 1px solid #ddd; padding: 8px;">
          {{ result.message.get_recipient().name }}
          <a href="{{ url_for('author_profile', author_id=result.message.get_recipient().id) }}?no_active_change=1"
            title="Im vollst√§ndigen Chat anzeigen"
            style="margin-left: 5px; text-decoration: none;">
            <img src="{{ url_for('static', filename='icons/arrow_out_square.svg') }}" alt="Arrow icon" style="width: 16px; height: 16px;">
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% elif keyword %}
      <p style="margin-top: 1rem; color: #888;">Keine Treffer f√ºr "<strong>{{ keyword }}</strong>" gefunden.</p>
  {% endif %}

  <!-- Search Form -->
  <form method="get" action="{{ url_for('konkordanz_view') }}">
    <div class="search-container" style="max-width: 600px;"> <!--set max width here!-->

      <!-- CONTAINER FOR EXTRA SEARCH BARS -->
      <div id="extra-search-fields">
        <!-- all dynamically inserted search bars go here -->
      </div>

      <!-- ADD SEARCH BUTTON -->
      <button type="button" id="add-search-btn"
              style="margin-top:1rem;padding:0.4rem 1rem;background:#6c757d;color:white;border:none;">
          + Weitere Suche
      </button>

      <button type="submit"
          style="margin-top: 1rem; padding: 0.4rem 1rem; font-size: 1rem; background-color: #0074D9; color: white; border: none;">
          Suchen
      </button>
  </form>

  <!-- Template for additional search bars -->
  <template id="search-template">
    <div class="search-group" style="margin-top:1rem; display:flex; gap:0.5rem; align-items:center;">

      <!-- Left dropdown ‚Äì fixed choices -->
      <select name="selected_type" class="search-konkordanz-dropdown">
        <option value="error-category">Category</option>
        <option value="error-ruleId">RuleId</option>
      </select>

      <!-- Search bar -->
      <div class="search-konkordanz-bar" style="display:flex; align-items:center; gap:0.5rem;">
        <input type="text"
              name="keyword"
              class="search-konkordanz-input"
              placeholder="Suchbegriff...">

        <div class="search-konkordanz-options">
          <span class="search-toggle" title="Gro√ü-/Kleinschreibung">Aa</span>
          <span class="search-toggle" title="Nur ganze W√∂rter suchen">ab|</span>
          <span class="search-toggle" title="Regul√§ren Ausdruck verwenden">.*</span>
        </div>

        <input type="checkbox" class="hidden-toggle" name="case_sensitive[]" value="1">
        <input type="checkbox" class="hidden-toggle" name="whole_word[]" value="1">
        <input type="checkbox" class="hidden-toggle" name="use_regex[]" value="1">
      </div>

      <!-- Right dropdown ‚Äì dynamic -->
      <select name="selected_scope" class="search-konkordanz-dropdown">
        {% for error in errors %}
            <option value="{{ error }}">{{ error }}</option>
        {% endfor %}
      </select>

      <!-- üóëÔ∏è Delete button -->
      <button type="button" class="delete-search-btn"
              style="padding:0.3rem 0.6rem; background:#dc3545; color:white; border:none; border-radius:4px;">
        ‚úï
      </button>
    </div>
  </template>


</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Hide/show ‚Äúrecipient‚Äù column ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  const toggleRecipient = document.getElementById('toggle-recipient');
  if (toggleRecipient) {
    toggleRecipient.addEventListener('change', function () {
      const display = this.checked ? '' : 'none';
      const col = 3;                                    // 0‚Äëbased index
      document.querySelectorAll(`table th:nth-child(${col + 1}), 
                                 table td:nth-child(${col + 1})`)
              .forEach(el => el.style.display = display);
    });
  }

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Add / delete extra search bars ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  const template   = document.getElementById('search-template');
  const container  = document.getElementById('extra-search-fields');
  const addBtn     = document.getElementById('add-search-btn');

  let toggleIndex = 1;   // keeps IDs unique across clones

  addBtn.addEventListener('click', () => {
    const clone = template.content.firstElementChild.cloneNode(true);

    /** give each hidden checkbox a unique ID and wire its button **/
    const types = ['case_sensitive', 'whole_word', 'use_regex'];
    clone.querySelectorAll('.hidden-toggle').forEach((cb, i) => {
      const id = `${types[i]}_${toggleIndex}`;
      cb.id = id;
      clone.querySelectorAll('.search-toggle')[i].dataset.toggleId = id;
    });
    toggleIndex++;

    container.appendChild(clone);
  });

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Delegate clicks (toggles & deletes) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  document.addEventListener('click', (e) => {
    /* delete button */
    if (e.target.matches('.delete-search-btn')) {
      e.target.closest('.search-group')?.remove();
      return;
    }

    /* toggle buttons */
    if (e.target.matches('.search-toggle')) {
      const id = e.target.dataset.toggleId;
      const cb = document.getElementById(id);
      if (cb) {
        cb.checked = !cb.checked;
        e.target.classList.toggle('active', cb.checked);
      }
    }
  });
});
</script>

{% endblock %}
