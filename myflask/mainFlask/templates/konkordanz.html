{% extends "layout.html" %}

{% block content %}
<div style="padding: 2rem; font-size: 1rem;">
  <h2 style="margin-bottom: 1rem;">
    <i class="fas fa-align-left"></i> Konkordanzansicht
  </h2>

  {% if keyword %}
      <p>Suchergebnisse für: <strong>{{ keyword }}</strong></p>
  {% endif %}

  {% if results %}
  <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
    <thead>
      <tr>
        <th style="width: 30%; border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">Left Context</th>
        <th style="width: 10%; border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">Hit</th>
        <th style="width: 30%; border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">Right Context</th>
        <th style="width: 20%; border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">Empfänger</th>
      </tr>
    </thead>
    <tbody>
      {% for result in results %}
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">{{ result.left }}</td>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; color: #0074D9; white-space: nowrap;">
          {{ result.matched_word }}
          <a href="{{ url_for('chat_view', chat_id=result.message.chat_id, keyword=keyword) }}#msg-{{ result.message.message_id }}"
            title="Im vollständigen Chat anzeigen"
            style="margin-left: 5px; text-decoration: none;">
            <img src="{{ url_for('static', filename='icons/arrow_out_square.svg') }}" alt="Arrow icon" style="width: 16px; height: 16px;">
          </a>
        </td>
        <td style="border: 1px solid #ddd; padding: 8px;">{{ result.right }}</td>
        <td style="border: 1px solid #ddd; padding: 8px;">
          {{ result.message.get_recipient().name }}
          <a href="{{ url_for('author_profile', author_id=result.message.get_recipient().id) }}?no_active_change=1"
            title="Im vollständigen Chat anzeigen"
            style="margin-left: 5px; text-decoration: none;">
            <img src="{{ url_for('static', filename='icons/arrow_out_square.svg') }}" alt="Arrow icon" style="width: 16px; height: 16px;">
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% elif keyword %}
      <p style="margin-top: 1rem; color: #888;">Keine Treffer für "<strong>{{ keyword }}</strong>" gefunden.</p>
  {% endif %}

  <!-- Search Form -->
  <form method="get" action="{{ url_for('konkordanz_view') }}">
    <div class="search-container" style="max-width: 600px;"> <!--set max width here!-->

      <div id="extra-search-fields">
        {% for n in nodes %}
          <div class="search-group" style="margin-top:1rem; display:flex; gap:0.5rem; align-items:center;">

            <!-- Left dropdown -->
            <select name="selected_type[{{ loop.index0 }}]" class="search-konkordanz-dropdown">
              <option value="" {% if not n.filter_type %}selected{% endif %}>— Type —</option>
              {% for ft in filter_types %}
                <option value="{{ ft.value }}"
                        {% if ft == n.filter_type %}selected{% endif %}>
                  {{ ft.name.title().replace('_', ' ') }}
                </option>
              {% endfor %}
            </select>

            <!-- Keyword input -->
            <div class="search-konkordanz-bar" style="display:flex; align-items:center; gap:0.5rem;">
              <input  type="text"
                      name="keyword[{{ loop.index0 }}]"
                      class="search-konkordanz-input"
                      placeholder="Suchbegriff..."
                      value="{{ n.searchbar_input }}"
                      {% if n.filter_type != filter_types.WORD %}disabled{% endif %}>

              <div class="search-konkordanz-options">
                <span class="search-toggle" title="Groß-/Kleinschreibung"
                      data-toggle-id="case_sensitive_{{ loop.index0 }}">Aa</span>
                <span class="search-toggle" title="Nur ganze Wörter suchen"
                      data-toggle-id="whole_word_{{ loop.index0 }}">ab|</span>
                <span class="search-toggle" title="Regulären Ausdruck verwenden"
                      data-toggle-id="use_regex_{{ loop.index0 }}">.*</span>
              </div>

              <!-- Hidden toggles -->
              <input type="checkbox" id="case_sensitive_{{ loop.index0 }}"
                    class="hidden-toggle"
                    name="case_sensitive[{{ loop.index0 }}]"
                    value="1" {% if n.case_sensitive %}checked{% endif %}>
              <input type="checkbox" id="whole_word_{{ loop.index0 }}"
                    class="hidden-toggle"
                    name="whole_word[{{ loop.index0 }}]"
                    value="1" {% if n.whole_word %}checked{% endif %}>
              <input type="checkbox" id="use_regex_{{ loop.index0 }}"
                    class="hidden-toggle"
                    name="use_regex[{{ loop.index0 }}]"
                    value="1" {% if n.use_regex %}checked{% endif %}>
            </div>

            <!-- colour swatch -->
            <label class="color-picker-label">
              <input type="color"
                    name="selected_color[{{ loop.index0 }}]"
                    value="{{ n.selected_color or '#ff0000' }}"
                    class="color-input">
              <span class="color-picker-text">🎨</span>
            </label>

            <!-- Right dropdown -->
            <select name="selected_scope[{{ loop.index0 }}]"
                    class="search-konkordanz-dropdown"
                    {% if not n.scope_choices %}disabled{% endif %}>
              <option value="" {% if not n.selected_value %}selected{% endif %}>— Please select —</option>
              {% for val in n.scope_choices %}
                <option value="{{ val }}"
                        {% if val == n.selected_value %}selected{% endif %}>
                  {{ val }}
                </option>
              {% endfor %}
            </select>

            <!-- Result count display -->
            <span class="result-label {% if n.search_result_list | length > 0 %}green{% else %}red{% endif %}">
              <span>Result:</span>
              <span>{{ n.search_result_list | length }}</span>
            </span>

            <!-- Delete button -->
            <button type="button" class="delete-search-btn"
                    style="padding:0.3rem 0.6rem; background:#dc3545; color:white; border:none; border-radius:4px;">
              ✕
            </button>
          </div>
        {% endfor %}
      </div>


      <!-- ADD SEARCH BUTTON -->
      <button type="button" id="add-search-btn"
              style="margin-top:1rem;padding:0.4rem 1rem;background:#6c757d;color:white;border:none;">
          + Weitere Suche
      </button>

      <button type="submit"
          style="margin-top: 1rem; padding: 0.4rem 1rem; font-size: 1rem; background-color: #0074D9; color: white; border: none;">
          Suchen
      </button>
  </form>

  <!-- Template for additional search bars -->
  <template id="search-template">
    <div class="search-group" style="margin-top:1rem; display:flex; gap:0.5rem; align-items:center;">

      <!-- Left dropdown – values come from the Enum -->
      <select name="selected_type" class="search-konkordanz-dropdown">
        <option value="" selected>— Type —</option>
        {% for ft in filter_types %}
          <option value="{{ ft.value }}">{{ ft.name.title().replace('_', ' ') }}</option>
        {% endfor %}
      </select>

      <!-- Search bar -->
      <div class="search-konkordanz-bar" style="display:flex; align-items:center; gap:0.5rem;">
        <input type="text"
              name="keyword"
              class="search-konkordanz-input"
              placeholder="Suchbegriff...">

        <div class="search-konkordanz-options">
          <span class="search-toggle" title="Groß-/Kleinschreibung">Aa</span>
          <span class="search-toggle" title="Nur ganze Wörter suchen">ab|</span>
          <span class="search-toggle" title="Regulären Ausdruck verwenden">.*</span>
        </div>

        <!-- Hidden toggles: keep names with [] so the JS can identify and rename them -->
        <input type="checkbox" class="hidden-toggle" name="case_sensitive[]" value="1">
        <input type="checkbox" class="hidden-toggle" name="whole_word[]"     value="1">
        <input type="checkbox" class="hidden-toggle" name="use_regex[]"      value="1">
      </div>

      <!-- colour swatch -->
      <label class="color-picker-label">
        <input type="color" name="selected_color[]" value="#ff0000" class="color-input">
        <span class="color-picker-text">🎨</span>
      </label>

      <!-- Right dropdown – dynamic -->
      <select name="selected_scope" class="search-konkordanz-dropdown">

      </select>

      <!-- 🗑️ Delete button -->
      <button type="button" class="delete-search-btn"
              style="padding:0.3rem 0.6rem; background:#dc3545; color:white; border:none; border-radius:4px;">
        ✕
      </button>
    </div>
  </template>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {

  /* ───────── Hide/show “recipient” column ───────── */
  const toggleRecipient = document.getElementById('toggle-recipient');
  if (toggleRecipient) {
    toggleRecipient.addEventListener('change', function () {
      const col = 3;
      const display = this.checked ? '' : 'none';
      document
        .querySelectorAll(`table th:nth-child(${col + 1}), table td:nth-child(${col + 1})`)
        .forEach(el => el.style.display = display);
    });
  }

  /* ───────── References & state ───────── */
  const template  = document.getElementById('search-template');
  const container = document.getElementById('extra-search-fields');
  const addBtn    = document.getElementById('add-search-btn');

  let toggleIndex = 1;
  let barIndex    = 0;

  /* ───────── Helpers ───────── */

  function addEmptyOption(select) {
    if (!select || select.querySelector('option[value=""]')) return;
    const empty = document.createElement('option');
    empty.value = '';
    empty.textContent = '— Please select —';
    select.insertBefore(empty, select.firstChild);
    select.value = '';
    select.disabled = true;
  }

  function createSearchBar() {
    const frag  = template.content.cloneNode(true);
    const clone = frag.querySelector('.search-group');
    if (!clone) return console.error('Template missing .search-group');

    // --- left, right dropdowns ---
    const leftSel  = clone.querySelector('select[name="selected_type"]');
    const rightSel = clone.querySelector('select[name="selected_scope"]');

    // --- keyword input (grab ONCE!) ---
    const keywordInput = clone.querySelector('input[name="keyword"]');

    /* index field names */
    keywordInput.name = `keyword[${barIndex}]`;
    leftSel.name      = `selected_type[${barIndex}]`;
    rightSel.name     = `selected_scope[${barIndex}]`;
    const colorInput = clone.querySelector('input[type="color"]');
      if (colorInput) {
        colorInput.name = `selected_color[${barIndex}]`;
      }

    clone.querySelectorAll('.hidden-toggle').forEach(cb => {
      const base = cb.name.replace('[]', '');
      cb.name = `${base}[${barIndex}]`;
    });
    barIndex++;

    /* keyword starts disabled */
    keywordInput.disabled = true;

    /* unique IDs for toggle spans */
    const types = ['case_sensitive', 'whole_word', 'use_regex'];
    clone.querySelectorAll('.hidden-toggle').forEach((cb, i) => {
      const id = `${types[i]}_${toggleIndex}`;
      cb.id = id;
      clone.querySelectorAll('.search-toggle')[i].dataset.toggleId = id;
    });
    toggleIndex++;

    addEmptyOption(rightSel);
    container.appendChild(clone);
  }

  /* ───────── Initial setup ───────── */

  if (!document.querySelector('.search-group')) {
      createSearchBar();
  }                   // one bar on load
  addBtn.addEventListener('click', createSearchBar);

  /* ───────── Delegated clicks ───────── */
  document.addEventListener('click', (e) => {
    if (e.target.matches('.delete-search-btn')) {
      e.target.closest('.search-group')?.remove();
      return;
    }
    if (e.target.matches('.search-toggle')) {
      const cb = document.getElementById(e.target.dataset.toggleId);
      if (cb) {
        cb.checked = !cb.checked;
        e.target.classList.toggle('active', cb.checked);
      }
    }
  });

  /* ───────── Main change handler ───────── */
  container.addEventListener('change', async (ev) => {
    const left = ev.target.closest('select[name^="selected_type"]');
    if (!left) return;

    const group = left.closest('.search-group');
    const right = group?.querySelector('select[name^="selected_scope"]');
    const input = group?.querySelector('input[name^="keyword"]');
    if (!right || !input) return;

    /* enable/disable keyword input */
    if (left.value === 'word') {
      input.disabled = false;
    } else {
      input.value = '';
      input.disabled = true;
    }

    if (!left.value) {
      right.innerHTML = '<option value="" selected>— Please select —</option>';
      right.disabled  = true;
      return;
    }

    try {
      const resp  = await fetch(`/api/filter-values?type=${encodeURIComponent(left.value)}`);
      if (!resp.ok) throw new Error(await resp.text());
      const items = await resp.json();

      right.innerHTML = '';
      addEmptyOption(right);
      right.disabled = items.length === 0;

      items.forEach(v => {
        const opt = document.createElement('option');
        opt.value = opt.textContent = v;
        right.appendChild(opt);
      });
    } catch (err) {
      console.error(err);
      alert('Fehler beim Laden der Werte');
    }
  });

  /* ───────── Restore toggle button states on page load ───────── */
  document.querySelectorAll('.hidden-toggle').forEach(cb => {
    if (cb.checked) {
      const toggleSpan = document.querySelector(`.search-toggle[data-toggle-id="${cb.id}"]`);
      if (toggleSpan) {
        toggleSpan.classList.add('active');
      }
    }
  });

});
</script>
{% endblock %}

