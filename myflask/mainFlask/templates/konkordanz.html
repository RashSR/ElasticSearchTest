{% extends "layout.html" %}

{% block content %}
<div style="padding: 2rem; font-size: 1rem;">
    <h2 style="margin-bottom: 1rem;">
        <i class="fas fa-align-left"></i> Konkordanzansicht
    </h2>

    {% if keyword %}
        <p>Suchergebnisse f√ºr: <strong>{{ keyword }}</strong></p>
    {% endif %}

    {% if results %}
    <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
        <thead>
            <tr>
                <th style="width: 30%; border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">Left Context</th>
                <th style="width: 10%; border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">Hit</th>
                <th style="width: 30%; border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">Right Context</th>
                <th style="width: 20%; border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">Empf√§nger</th>
            </tr>
        </thead>
        <tbody>
        {% for result in results %}
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ result.left }}</td>
            <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; color: #0074D9; white-space: nowrap;">
                {{ result.matched_word }}
                <a href="{{ url_for('chat_view', chat_id=result.message.chat_id, keyword=keyword) }}#msg-{{ result.message.message_id }}"
                    title="Im vollst√§ndigen Chat anzeigen"
                    style="margin-left: 5px; text-decoration: none;">
                    <img src="{{ url_for('static', filename='icons/arrow_out_square.svg') }}" alt="Arrow icon" style="width: 16px; height: 16px;">
                </a>
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ result.right }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                {{ result.message.get_recipient().name }}
                <a href="{{ url_for('author_profile', author_id=result.message.get_recipient().id) }}?no_active_change=1"
                    title="Im vollst√§ndigen Chat anzeigen"
                    style="margin-left: 5px; text-decoration: none;">
                    <img src="{{ url_for('static', filename='icons/arrow_out_square.svg') }}" alt="Arrow icon" style="width: 16px; height: 16px;">
                </a>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    {% elif keyword %}
        <p style="margin-top: 1rem; color: #888;">Keine Treffer f√ºr "<strong>{{ keyword }}</strong>" gefunden.</p>
    {% endif %}

    <!-- Search Form -->
    <form method="get" action="{{ url_for('konkordanz_view') }}">
        <div id="primary-search">
            <div class="search-konkordanz-bar">
                <!-- Search Input -->
                <input type="text" name="keyword" value="{{ keyword or '' }}" class="search-konkordanz-input" placeholder="Suchbegriff..." required>

                <!-- Icon-style Toggle Buttons -->
                <div class="search-konkordanz-options">
                    <span class="search-toggle {% if case_sensitive %}active{% endif %}" data-toggle-id="case_sensitive" title="Gro√ü-/Kleinschreibung">Aa</span>
                    <span class="search-toggle {% if whole_word %}active{% endif %}" data-toggle-id="whole_word" title="Nur ganze W√∂rter suchen">ab|</span>
                    <span class="search-toggle {% if use_regex %}active{% endif %}" data-toggle-id="use_regex" title="Regul√§ren Ausdruck verwenden">.*</span>
                </div>

                <!-- Hidden Checkboxes -->
                <input type="checkbox" class="hidden-toggle" name="case_sensitive" value="1" id="case_sensitive" {% if case_sensitive %}checked{% endif %}>
                <input type="checkbox" class="hidden-toggle" name="whole_word" value="1" id="whole_word" {% if whole_word %}checked{% endif %}>
                <input type="checkbox" class="hidden-toggle" name="use_regex" value="1" id="use_regex" {% if use_regex %}checked{% endif %}>
            </div>
        </div>

        <!-- üü® CONTAINER FOR EXTRA SEARCH BARS -->
        <div id="extra-search-fields"></div>

        <!-- üü© ADD SEARCH BUTTON -->
        <button type="button" id="add-search-btn"
                style="margin-top:1rem;padding:0.4rem 1rem;background:#6c757d;color:white;border:none;">
            + Weitere Suche
        </button>

        <button type="submit"
            style="margin-top: 1rem; padding: 0.4rem 1rem; font-size: 1rem; background-color: #0074D9; color: white; border: none;">
            Suchen
        </button>
    </form>

    <!-- üîµ TEMPLATE FOR CLONING NEW SEARCH BARS -->
    <template id="search-template">
        <div class="search-group" style="margin-top:1rem;">
            <div class="search-konkordanz-bar">
                <input type="text" name="keyword" class="search-konkordanz-input" placeholder="Suchbegriff..." required>

                <div class="search-konkordanz-options">
                    <span class="search-toggle" title="Gro√ü-/Kleinschreibung">Aa</span>
                    <span class="search-toggle" title="Nur ganze W√∂rter suchen">ab|</span>
                    <span class="search-toggle" title="Regul√§ren Ausdruck verwenden">.*</span>
                </div>

                <input type="checkbox" class="hidden-toggle" name="case_sensitive[]" value="1">
                <input type="checkbox" class="hidden-toggle" name="whole_word[]" value="1">
                <input type="checkbox" class="hidden-toggle" name="use_regex[]" value="1">
            </div>
        </div>
    </template>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.getElementById('toggle-recipient').addEventListener('change', function() {
    const displayStyle = this.checked ? '' : 'none';
    const colIndex = 3; // Recipient column is 4th column, so index 3 (zero-based)
    
    document.querySelectorAll(`table th:nth-child(${colIndex + 1})`).forEach(th => {
      th.style.display = displayStyle;
    });
    document.querySelectorAll(`table td:nth-child(${colIndex + 1})`).forEach(td => {
      td.style.display = displayStyle;
    });
  });
</script>
<script>
  // Toggle logic
  document.querySelectorAll('.search-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      const toggleId = btn.dataset.toggleId;
      const checkbox = document.getElementById(toggleId);
      checkbox.checked = !checkbox.checked;
      btn.classList.toggle('active', checkbox.checked);
    });
  });
</script>
<script>
(function () {
  let toggleIndex = 1;

  // Add Search bar logic
  document.getElementById('add-search-btn').addEventListener('click', () => {
    const tpl = document.getElementById('search-template');
    const clone = tpl.content.cloneNode(true);

    // Handle toggle buttons + link them to checkboxes
    const toggles = clone.querySelectorAll('.search-toggle');
    const checkboxes = clone.querySelectorAll('.hidden-toggle');

    toggles.forEach((btn, i) => {
      const type = ['case_sensitive', 'whole_word', 'use_regex'][i];
      const newId = `${type}_${toggleIndex}`;
      checkboxes[i].id = newId;
      btn.dataset.toggleId = newId;

      btn.addEventListener('click', () => {
        const cb = btn.previousElementSibling;
        cb.checked = !cb.checked;
        btn.classList.toggle('active', cb.checked);
      });
    });

    toggleIndex++;
    document.getElementById('extra-search-fields').appendChild(clone);
  });

  // First toggle group
  document.querySelectorAll('.search-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      const toggleId = btn.dataset.toggleId;
      const checkbox = document.getElementById(toggleId);
      checkbox.checked = !checkbox.checked;
      btn.classList.toggle('active', checkbox.checked);
    });
  });
})();
</script>
{% endblock %}
