{% extends "layout.html" %}

{% block content %}
{% if chat %}
    {% set chat_partner = (chat.get_participant_names() | reject('equalto', author.name) | list)[0] %}
    {% set name_parts = chat_partner.split(' ') %}
    {% set initials = name_parts[0][0] ~ (name_parts[-1][0] if name_parts | length > 1 else '') %}

    <div class="chat-header">
        <div class="avatar">{{ initials }}</div>
        <div class="chat-partner-info">
            <strong>{{ chat_partner }}</strong>
            Bekanntheitsgrad: {{ beziehung[chat.chat_id-1] }}
        </div>
    </div>

    <div class="chat-box" id="chat-box">
        {% set ns = namespace(previous_date=None) %}
        {% for message in chat.messages %}
            {% set message_date = message.timestamp.date() %}
            {% if message_date != ns.previous_date %}
                <div class="date-divider">
                    {{ message.timestamp.strftime('%A, %d. %B %Y') }}
                </div>
                {% set ns.previous_date = message_date %}
            {% endif %}

            <div id="msg-{{ message.message_id }}" class="message {{ 'sent' if message.sender.name == author.name else 'received' }}">
                {% if message.quoted_message %}
                    <div class="quoted">{{ message.quoted_message }}</div>
                {% endif %}
                {% if keyword %}
                    <div class="text">
                        {{ message.content | replace(keyword, '<mark>' ~ keyword ~ '</mark>') | safe }}
                    </div>
                {% else %}
                    <div class="text">{{ message.content }}</div>
                {% endif %}
                <div class="timestamp">{{ message.timestamp.strftime('%I:%M %p').lstrip('0') }}</div>
            </div>
        {% endfor %}
        <div id="scroll-anchor"></div>
    </div>
{% else %}
    <div class="no-element-selected">
        <p style="text-align: center; margin-top: 40px; color: #777;">
            WÃ¤hle einen Chat aus der Liste links aus.
        </p>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  window.addEventListener('load', function () {
    const anchor = document.getElementById('scroll-anchor');
    if (anchor) {
      anchor.scrollIntoView({ behavior: 'auto' });
    }
  });
</script>
<script>
window.onload = function () {
    const anchor = window.location.hash;
    if (anchor) {
        const el = document.querySelector(anchor);
        if (el) {
            el.classList.add("highlighted");
            el.scrollIntoView({ behavior: "smooth", block: "center" });
        }
    }
};
</script>

{% endblock %}